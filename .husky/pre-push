#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Check if we're in a Java project
if [ -f "pom.xml" ]; then
    echo "â˜• Java project detected, running comprehensive checks..."
    
    # Run full test suite
    echo "ğŸ§ª Running full test suite..."
    mvn clean test
    
    if [ $? -ne 0 ]; then
        echo "âŒ Tests failed. Push cancelled."
        exit 1
    fi
    
    # Run quality checks
    echo "ğŸ” Running quality checks..."
    mvn checkstyle:check spotbugs:check pmd:check
    
    if [ $? -ne 0 ]; then
        echo "âŒ Quality checks failed. Push cancelled."
        exit 1
    fi
    
    # Check coverage
    echo "ğŸ“Š Checking test coverage..."
    mvn jacoco:check
    
    if [ $? -ne 0 ]; then
        echo "âŒ Coverage threshold not met. Push cancelled."
        exit 1
    fi
    
    echo "âœ… All pre-push checks passed!"
else
    echo "ğŸ“ Non-Java project, running basic checks..."
    
    # Check for sensitive information
    if grep -r "password\|secret\|key\|token" --include="*.java" --include="*.js" --include="*.ts" --include="*.properties" --include="*.yml" --include="*.yaml" .; then
        echo "âš ï¸  Potential sensitive information found. Please review."
    fi
    
    echo "âœ… Basic pre-push checks passed!"
fi

echo "ğŸ‰ All pre-push checks passed! Proceeding with push..."
