<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Usu√°rios - User Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2em;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            transition: background 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .controls-row {
            display: flex;
            gap: 20px;
            align-items: end;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .users-table {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            background: #34495e;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            font-size: 1.5em;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .actions-cell {
            display: flex;
            gap: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2c3e50;
        }

        .close {
            font-size: 2em;
            cursor: pointer;
            color: #7f8c8d;
        }

        .close:hover {
            color: #2c3e50;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .field-error {
            color: #e74c3c;
            font-size: 0.8em;
            margin-top: 5px;
            min-height: 20px;
        }

        .field-error:empty {
            display: none;
        }

        .form-group input.error {
            border-color: #e74c3c;
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .controls-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .actions-cell {
                flex-direction: column;
            }
            
            .table-container {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üë• Gerenciar Usu√°rios</h1>
            <div class="nav-links">
                <a href="/">üè† Home</a>
                <a href="/dashboard">üìä Dashboard</a>
                <a href="/status">üîß Status</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <div class="controls-row">
                <div class="form-group">
                    <label for="searchInput">üîç Buscar por nome:</label>
                    <input type="text" id="searchInput" placeholder="Digite o nome do usu√°rio...">
                </div>
                <div class="form-group">
                    <label for="ageFilter">üìÖ Faixa et√°ria:</label>
                    <select id="ageFilter">
                        <option value="">Todas as idades</option>
                        <option value="18-25">18-25 anos</option>
                        <option value="26-35">26-35 anos</option>
                        <option value="36-50">36-50 anos</option>
                        <option value="50+">50+ anos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="statusFilter">üìä Status:</label>
                    <select id="statusFilter">
                        <option value="">Todos</option>
                        <option value="true">Ativos</option>
                        <option value="false">Inativos</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="searchUsers()">üîç Buscar</button>
                <button class="btn btn-success" onclick="openCreateModal()">‚ûï Novo Usu√°rio</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="users-table">
            <div class="table-header">
                <h2>Lista de Usu√°rios</h2>
                <button class="btn btn-primary" onclick="loadUsers()">üîÑ Atualizar</button>
            </div>
            <div class="table-container">
                <div id="loadingIndicator" class="loading">
                    <div class="spinner"></div>
                    <p>Carregando usu√°rios...</p>
                </div>
                <table id="usersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Telefone</th>
                            <th>Idade</th>
                            <th>Status</th>
                            <th>Criado em</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para criar/editar usu√°rio -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Novo Usu√°rio</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="userForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="userName">Nome *</label>
                        <input type="text" id="userName" required minlength="2" maxlength="100">
                        <div id="nameError" class="field-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email *</label>
                        <input type="email" id="userEmail" required>
                        <div id="emailError" class="field-error"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="userPhone">Telefone</label>
                        <input type="tel" id="userPhone" placeholder="(11) 99999-9999">
                        <div id="phoneError" class="field-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="userAge">Idade *</label>
                        <input type="number" id="userAge" min="0" max="120" required>
                        <div id="ageError" class="field-error"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="userActive" checked> Usu√°rio ativo
                    </label>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-warning" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUserId = null;
        let allUsers = [];

        // Carregar usu√°rios ao inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            
            // Event listeners
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
            document.getElementById('searchInput').addEventListener('input', debounce(searchUsers, 300));
            document.getElementById('ageFilter').addEventListener('change', searchUsers);
            document.getElementById('statusFilter').addEventListener('change', searchUsers);
        });

        // Carregar todos os usu√°rios
        async function loadUsers() {
            showLoading(true);
            try {
                const response = await fetch('/api/users');
                allUsers = await response.json();
                displayUsers(allUsers);
                showAlert('Usu√°rios carregados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                showAlert('Erro ao carregar usu√°rios: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Exibir usu√°rios na tabela
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7f8c8d;">Nenhum usu√°rio encontrado</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${user.age}</td>
                    <td><span class="status-badge ${user.active ? 'status-active' : 'status-inactive'}">${user.active ? 'Ativo' : 'Inativo'}</span></td>
                    <td>${new Date(user.createdAt).toLocaleDateString('pt-BR')}</td>
                    <td class="actions-cell">
                        <button class="btn btn-warning btn-sm" onclick="editUser(${user.id})">‚úèÔ∏è</button>
                        <button class="btn ${user.active ? 'btn-danger' : 'btn-success'} btn-sm" onclick="toggleUserStatus(${user.id}, ${user.active})">
                            ${user.active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Buscar usu√°rios
        async function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const ageFilter = document.getElementById('ageFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filteredUsers = allUsers;

            // Filtro por nome
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user => 
                    user.name.toLowerCase().includes(searchTerm)
                );
            }

            // Filtro por idade
            if (ageFilter) {
                const [minAge, maxAge] = ageFilter.split('-').map(Number);
                filteredUsers = filteredUsers.filter(user => {
                    if (ageFilter === '50+') {
                        return user.age >= 50;
                    }
                    return user.age >= minAge && user.age <= maxAge;
                });
            }

            // Filtro por status
            if (statusFilter !== '') {
                filteredUsers = filteredUsers.filter(user => 
                    user.active === (statusFilter === 'true')
                );
            }

            displayUsers(filteredUsers);
        }

        // Abrir modal para criar usu√°rio
        function openCreateModal() {
            currentUserId = null;
            document.getElementById('modalTitle').textContent = 'Novo Usu√°rio';
            document.getElementById('userForm').reset();
            document.getElementById('userActive').checked = true;
            clearFieldErrors();
            document.getElementById('userModal').style.display = 'block';
        }

        // Editar usu√°rio
        function editUser(id) {
            const user = allUsers.find(u => u.id === id);
            if (!user) return;

            currentUserId = id;
            document.getElementById('modalTitle').textContent = 'Editar Usu√°rio';
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userAge').value = user.age;
            document.getElementById('userActive').checked = user.active;
            clearFieldErrors();
            document.getElementById('userModal').style.display = 'block';
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('userModal').style.display = 'none';
            currentUserId = null;
        }

        // Submeter formul√°rio
        async function handleUserSubmit(e) {
            e.preventDefault();
            
            // Validar campos
            if (!validateForm()) {
                return;
            }
            
            const userData = {
                name: document.getElementById('userName').value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                phone: document.getElementById('userPhone').value.trim(),
                age: parseInt(document.getElementById('userAge').value),
                active: document.getElementById('userActive').checked
            };

            try {
                let response;
                if (currentUserId) {
                    // Atualizar usu√°rio existente
                    response = await fetch(`/api/users/${currentUserId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                } else {
                    // Criar novo usu√°rio
                    response = await fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                }

                if (response.ok) {
                    showAlert(currentUserId ? 'Usu√°rio atualizado com sucesso!' : 'Usu√°rio criado com sucesso!', 'success');
                    closeModal();
                    loadUsers();
                } else {
                    const error = await response.text();
                    showAlert('Erro: ' + error, 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar usu√°rio:', error);
                showAlert('Erro ao salvar usu√°rio: ' + error.message, 'error');
            }
        }

        // Alternar status do usu√°rio
        async function toggleUserStatus(id, currentStatus) {
            try {
                const endpoint = currentStatus ? `/api/users/${id}/deactivate` : `/api/users/${id}/activate`;
                const response = await fetch(endpoint, {
                    method: 'PATCH'
                });

                if (response.ok) {
                    showAlert(`Usu√°rio ${currentStatus ? 'desativado' : 'ativado'} com sucesso!`, 'success');
                    loadUsers();
                } else {
                    showAlert('Erro ao alterar status do usu√°rio', 'error');
                }
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                showAlert('Erro ao alterar status: ' + error.message, 'error');
            }
        }

        // Deletar usu√°rio
        async function deleteUser(id) {
            if (!confirm('Tem certeza que deseja deletar este usu√°rio?')) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Usu√°rio deletado com sucesso!', 'success');
                    loadUsers();
                } else {
                    showAlert('Erro ao deletar usu√°rio', 'error');
                }
            } catch (error) {
                console.error('Erro ao deletar usu√°rio:', error);
                showAlert('Erro ao deletar usu√°rio: ' + error.message, 'error');
            }
        }

        // Mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('usersTable').style.display = show ? 'none' : 'table';
        }

        // Mostrar alerta
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('userModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Fun√ß√µes de valida√ß√£o
        function validateForm() {
            let isValid = true;
            
            // Limpar erros anteriores
            clearFieldErrors();
            
            // Validar nome
            const name = document.getElementById('userName').value.trim();
            if (!name || name.length < 2) {
                showFieldError('nameError', 'Nome deve ter pelo menos 2 caracteres');
                markFieldError('userName');
                isValid = false;
            }
            
            // Validar email
            const email = document.getElementById('userEmail').value.trim();
            if (!email) {
                showFieldError('emailError', 'Email √© obrigat√≥rio');
                markFieldError('userEmail');
                isValid = false;
            } else if (!isValidEmail(email)) {
                showFieldError('emailError', 'Formato de email inv√°lido');
                markFieldError('userEmail');
                isValid = false;
            }
            
            // Validar telefone (opcional, mas se preenchido deve ser v√°lido)
            const phone = document.getElementById('userPhone').value.trim();
            if (phone && !isValidPhone(phone)) {
                showFieldError('phoneError', 'Formato de telefone inv√°lido. Use: (11) 99999-9999');
                markFieldError('userPhone');
                isValid = false;
            }
            
            // Validar idade
            const age = parseInt(document.getElementById('userAge').value);
            if (!age || age < 0 || age > 120) {
                showFieldError('ageError', 'Idade deve ser entre 0 e 120 anos');
                markFieldError('userAge');
                isValid = false;
            }
            
            return isValid;
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function isValidPhone(phone) {
            // Aceita formatos: (11) 99999-9999, (11) 9999-9999, 11999999999, 1199999999
            const phoneRegex = /^(\(\d{2}\)\s?\d{4,5}-?\d{4}|\d{10,11})$/;
            return phoneRegex.test(phone);
        }
        
        function showFieldError(fieldId, message) {
            document.getElementById(fieldId).textContent = message;
        }
        
        function markFieldError(fieldId) {
            document.getElementById(fieldId).classList.add('error');
        }
        
        function clearFieldErrors() {
            const errorFields = ['nameError', 'emailError', 'phoneError', 'ageError'];
            const inputFields = ['userName', 'userEmail', 'userPhone', 'userAge'];
            
            errorFields.forEach(fieldId => {
                document.getElementById(fieldId).textContent = '';
            });
            
            inputFields.forEach(fieldId => {
                document.getElementById(fieldId).classList.remove('error');
            });
        }
        
        // Formata√ß√£o autom√°tica do telefone
        document.addEventListener('DOMContentLoaded', function() {
            const phoneInput = document.getElementById('userPhone');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
                    }
                    if (value.length >= 10) {
                        value = value.substring(0, 10) + '-' + value.substring(10, 14);
                    }
                    e.target.value = value;
                });
            }
        });
    </script>
</body>
</html>

